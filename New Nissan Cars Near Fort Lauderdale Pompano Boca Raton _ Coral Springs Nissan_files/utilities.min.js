class SRPUtilities {
    tempObjects = [];
    objects = [];
    project_id = "";
    vin = "";
    shroomOpened = false;
    createSRPShroomMarker(insertionPoint, project_id, vin) {
        this.project_id = project_id;
        this.vin = vin;
        this.createSRPStyling();
        this.fetchPOIData(insertionPoint);
    }

    createPOIs(insertionPoint) {
        console.log(this.objects);
        var addedPOI = false;
        var addedBlemish = false;
        var currentMarker = "";
        var self = this;
        if(this.objects != null){
            this.objects.forEach( function (item, index){
                var newEle = document.createElement("img");
                newEle.id = item.oname;
                if(item.poiType == "blemish") {
                    newEle.src = "https://ivana.sister.tv/models/exterior360_msk/img/blemish.png";
                    newEle.setAttribute("style",'position: absolute; z-index:9; top:2%; left:30px; display:block;width: 25px;cursor:pointer;');
                    currentMarker = "blemish";
                }  
                else {
                    newEle.src = "https://ivana.sister.tv/models/exterior360_msk/img/marker.png";
                    newEle.setAttribute("style",'position: absolute; z-index:9; top:2%; left:2%; display:block;width: 25px;cursor:pointer;');
                    currentMarker = "poi";
                }
                newEle.setAttribute("class",'markers-'+self.vin);
                newEle.classList.add("ez360-poi")
                newEle.setAttribute("alt", item.text);
                newEle.setAttribute("title", item.text);
                newEle.setAttribute("text", item.text);
                newEle.setAttribute("displayOn", item.displayOn);
                newEle.setAttribute("frames", item.frames);
                newEle.setAttribute("largeImage", item.largeImage);
                newEle.setAttribute("UFN", item.UFN);
                var tooltipHTML = "";
                if(currentMarker = "poi") {
                    tooltipHTML = "Point Of Interest";
                }
                else {
                    tooltipHTML = "Blemishes"; 
                }
                
                newEle.setAttribute("data-toggle", "tooltip");
                newEle.setAttribute("data-html", "true");
                newEle.setAttribute("data-bs-custom-class", "custom-tooltip");
                newEle.setAttribute("title", tooltipHTML);
                if((currentMarker == "poi" && addedPOI == false)) {
                    insertionPoint.appendChild(newEle);
                    addedPOI = true;
                }
                else if((currentMarker == "blemish" && addedBlemish == false)){
                    insertionPoint.appendChild(newEle);
                    addedBlemish = true;
                }
            });
            this.addMarkerEvent();
        }
    }
    
    createSRPStyling() {
        var style = document.createElement('style');
        style.innerHTML = `
        .poiButtonsEZ360SRP {
            z-index: 9999;
            width: 11%;
            position: absolute;
            height: 30px;
            overflow: hidden;
            top: 5px;
            left: 5px;
            padding: 10px;
            cursor: pointer;
            display: none;
        }
        
        .blemishBEZ360SRP {
            box-shadow: 0 0 0 0 yellow;
            transform: scale(1);
            animation: pulse 2s infinite;
            border-radius: 50%;
        }
    
        .poiBEZ360SRP {
            box-shadow: 0 0 0 0 #01b0ef;
            transform: scale(1);
            animation: pulse 2s infinite;
            border-radius: 50%;
        }

        #SRP-Shroom-Container-Move {
            padding: 10px;
            cursor: move;
            z-index: 10;
            background-color: #2196F3;
            color: #fff;
        }

        .ez360-poi {
            animation: pulse-poi 2s infinite;
        }

        @keyframes pulse-poi {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(52, 172, 224, 0.7);
            }
            
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(52, 172, 224, 0);
            }
            
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(52, 172, 224, 0);
            }
        }
        `
        
    }
    
    fetchPOIData(insertionPoint) {
        var url = 'https://ljw9dc2yxc.execute-api.us-east-1.amazonaws.com/spin-poi/api?id='+this.project_id+"-"+this.vin.toLowerCase();
        var xhr = new XMLHttpRequest();
        xhr.open("GET", url);
        xhr.responseType = "json";
        var self = this;
        xhr.onreadystatechange = function () { // Call a function when the state changes.
            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                var data = this.response;
                var dataa = data;
                if(dataa.length>0){
                    var spiObject = self;
                    dataa.forEach((element) => {
                        if(element.pois.length>0){
                            var UFN = element.pic_url.split("?")[0];
                            var mainPic = UFN;
                            UFN = UFN.split("/")[UFN.split("/").length-1];
                            UFN = UFN.split(".");
                            var curentImageNumber = 0;
                            var tempNo;
                            if(UFN.length>3);
                                curentImageNumber = UFN[2];
                            if(curentImageNumber>999){
                                if(spiObject.tempObjects == null)
                                    spiObject.tempObjects = [];
                                element.pois.forEach((poielement) => {
                                    var imagesList = ""+curentImageNumber;
                                    tempNo = curentImageNumber;
                                    for(var i=0;i<parseInt(poielement.frames);i++){
                                        tempNo++;
                                        imagesList = imagesList+","+tempNo;
                                    }
                                    tempNo = curentImageNumber;
                                    for(var i=0;i<parseInt(poielement.frames);i++){
                                        tempNo--;
                                        imagesList = tempNo+","+imagesList;
                                    }

                                    var poiindex = spiObject.tempObjects.length;
                                    spiObject.tempObjects[poiindex] = {oname:'newpoi_'+(poiindex),x: poielement.leftPercentage, y: poielement.topPercentage, z: 20, radius: 7, text:poielement.text , imagesList:imagesList, changePoint:curentImageNumber, frames:poielement.frames, largeImage:poielement.largeImage, displayOn:"", UFN:mainPic, poiType:poielement.poiType};
                                    if(poielement.poiType == "blemish")
                                        self.hasBlemishes = true;
                                    else
                                        self.hasPois = true;    
                                });
                                spiObject.objects = spiObject.tempObjects;
                            }
                        }
                    });
                    console.log(JSON.parse(JSON.stringify(spiObject.objects)));
                    self.createPOIs(insertionPoint);
                    //initiatePOIS();
                }
            }
        }
        xhr.send();
    }

    // what does clicking on marker do
    addMarkerEvent() {
        var markers = document.querySelector(".markers-"+this.vin);
        var self = this;
        markers.onclick = function() {
            self.showShroomPlayer();
        }
    }

    /* For showing Shroom */
    showShroomPlayer() {
        if(document.querySelector("#SRP-Shroom-Container") == null || document.querySelector("#SRP-Shroom-Container") == undefined) {
            var self = this;
            this.shroomOpened = true;
            var dimmedContainer = document.createElement("div");
            dimmedContainer.id = "SRP-Dimmed-Container";
            dimmedContainer.style.cssText = "position: fixed; top: 0;left: 0; width: 100%;height: 100%;background: rgba(0, 0, 0, 0.5);z-index: 3;display: block;cursor: pointer;"
            var containerDiv = document.createElement("div");
            containerDiv.id = "SRP-Shroom-Container";
            containerDiv.style.cssText = "position:fixed;height:80vh;width:60vw;z-index:10000;transform: translate(30%, 10%);";
            var shroomIframe = document.createElement("iframe");
            shroomIframe.id = "EZ360-shroom-player";
            shroomIframe.allowFullscreen = true;
            var fsClose = document.createElement("div");
            fsClose.style.cssText = "position:absolute;top:0.5rem;right:1%;cursor:pointer;z-index:2;opacity:1;";
            var containerMove = document.createElement("div");
            containerMove.style.cssText = "position:absolute;top:0;left:0;cursor:move;z-index:2;width:30px;height:30px;background:black;";
            containerMove.innerHTML = '<i class="fa fa-hand-rock-o" style="color: white; font-size: 28px; margin-left: 3px;" aria-hidden="true"></i>';
            containerMove.id = "SRP-Shroom-Container-Move";
            var fsCloseBtn = document.createElement("p");
            fsCloseBtn.innerHTML = "&#215;";
            fsCloseBtn.style.cssText = "position: absolute;width: 25px;height: 25px;right: -1px;top: 0px;color: #fff;background: red;border-radius: 3px;z-index: 12;font-size: 140%;text-align: center;cursor: pointer;";
            fsCloseBtn.onclick = function(){
                if(document.querySelector(".EZ360-fs-layer") !== null) {
                  document.querySelector(".EZ360-fs-layer").style.display = "none";
                }
                document.querySelector("#SRP-Shroom-Container").style.display = "none";
                document.querySelector("#SRP-Dimmed-Container").style.display = "none";
                self.shroomOpened = false;
                // shroomIframe.contentWindow.postMessage({
                //     'func': 'closePlayers'
                // },"*");
                // if (document.exitFullscreen) { document.exitFullscreen(); }
                // else if (document.mozCancelFullScreen) { document.mozCancelFullScreen(); }
                // else if (document.webkitCancelFullScreen) { document.webkitCancelFullScreen(); }
                // else if (document.msExitFullscreen) { document.msExitFullscreen(); }
            }
            // _setEleHover2(fsCloseBtn);
            fsClose.appendChild(fsCloseBtn);
            /* Open in another Tab */
            var openNewTabBtn = document.createElement("p");
            openNewTabBtn.innerHTML = '<i class="fa fa-external-link" style="color: white; font-size: 18px; margin-left: 3px;" aria-hidden="true"></i>';
            openNewTabBtn.style.cssText = "position: absolute;width: 25px;height: 25px;right: 35px;top: 0px;color: #fff;background: black;border-radius: 3px;z-index: 12;font-size: 140%;text-align: center;cursor: pointer;";
            openNewTabBtn.onclick = function(){
                window.open("https://shroom.sister.tv/?project_id="+self.project_id+"&vin="+self.vin+"&ratio="+EZ360_ARGS.ratio, '_blank').focus();
            }
            // _setEleHover2(openNewTabBtn);
            fsClose.appendChild(openNewTabBtn);
            shroomIframe.src = "https://shroom.sister.tv/?project_id="+this.project_id+"&vin="+this.vin+"&ratio="+EZ360_ARGS.ratio;
            shroomIframe.style.cssText = "display:block;position:absolute;width:100%;height:100%;overflow:hidden;";
            shroomIframe.setAttribute("scrolling", "no"); // no scroll bars for any reason
            containerDiv.appendChild(shroomIframe);
            containerDiv.appendChild(fsClose);
            containerDiv.appendChild(containerMove);
            document.body.prepend(dimmedContainer);
            document.body.prepend(containerDiv);
            document.body.style.position = "relative";
            containerDiv.style.display = "block";

            dimmedContainer.addEventListener('click', function() {
                dimmedContainer.style.display = 'none';
                containerDiv.style.display = 'none';
                self.shroomOpened = false;
            });

            // Create the link element
            var link = document.createElement("link");
            link.href = "https://sdk.sister.tv/libs/font-awesome/css/font-awesome.min.css";
            link.rel = "stylesheet";

            // Add the link element to the head of the document
            document.head.appendChild(link);

            /* This is for stop displaying shroom */
            const mql = window.matchMedia("(min-width: 1000px) and (min-height: 600px)");
            const handleOrientationChange = (mql) => {
                if (mql.matches) {
                    // console.log(self.shroomOpened);
                    if(self.shroomOpened === true) {
                        document.querySelector('#SRP-Shroom-Container').style.display = 'block';
                        document.querySelector("#SRP-Dimmed-Container").style.display = "block";
                    }
                } else {
                    if(self.shroomOpened === true) {
                        document.querySelector('#SRP-Shroom-Container').style.display = 'none';
                        document.querySelector("#SRP-Dimmed-Container").style.display = "none";
                    }
                }
            }

            handleOrientationChange(mql);
            mql.addListener(handleOrientationChange);
            this.dragElement(containerDiv);
        }
        else {
            this.shroomOpened = true;
            var containerDiv = document.querySelector("#SRP-Shroom-Container");
            var dimmedContainer = document.querySelector("#SRP-Dimmed-Container");
            var shroomIframe = containerDiv.getElementsByTagName("iframe")[0];
            /* Changing Source URL on click (like a refresh) */
            shroomIframe.src = "https://shroom.sister.tv/?project_id="+this.project_id+"&vin="+this.vin+"&ratio="+EZ360_ARGS.ratio;
            containerDiv.style.display = "block";
            dimmedContainer.style.display = "block";
        }
    }

    // Make the DIV element draggable:
    dragElement(elmnt) {
        // Get the elements
        var myDiv = document.getElementById("SRP-Shroom-Container");
        var anchorPoint = document.getElementById("SRP-Shroom-Container-Move");

        // Add event listeners for mousedown, mousemove, and mouseup on anchor point
        anchorPoint.addEventListener("mousedown", startMoving);
        document.addEventListener("mousemove", moveDiv);
        document.addEventListener("mouseup", stopMoving);

        // Initialize some variables for tracking the mouse
        var offset = [0,0];
        var isDown = false;

        function startMoving(e) {
            isDown = true;
            var rect = anchorPoint.getBoundingClientRect();
            console.log(rect, rect.left, e.clientX, rect.left - e.clientX)
            offset = [
                rect.left - e.clientX,
                rect.top - e.clientY
            ];
        }

        function moveDiv(e) {
            if (isDown) {
                myDiv.style.transform = "translate(" + (e.clientX + offset[0]) + "px, " + (e.clientY + offset[1]) + "px)";
            }
        }
        
        function stopMoving() {
            isDown = false;
        }
    }
}

