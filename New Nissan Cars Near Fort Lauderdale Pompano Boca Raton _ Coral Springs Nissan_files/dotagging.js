!function(){"use strict";window.dataLayer=window.dataLayer||[];class t{constructor(t,e){this._baseUrl=t,this._logger=e}async get(t,e){this._logger.debug("Sending HTTP GET to ",t);const n=new URL(`${t}?${e}`,this._baseUrl),i=await fetch(n.toString(),{headers:{accept:"application/json"}});return await i.json()}async post(t,e){this._logger.debug("Sending HTTP POST to ",t);const n=new URL(`${t}`,this._baseUrl),i=await fetch(n.toString(),{method:"POST",headers:{accept:"application/json","content-type":"application/x-www-form-urlencoded"},body:e});return await i.json()}static getBaseUrlFromScript(){const t=document.currentScript;if(t&&"src"in t){const e=t.src;return new URL(e).origin}return""}}var e,n;!function(t){t.ClickToCall="click_to_call",t.CtaInteraction="cta_interaction",t.ElementConfiguration="element_configuration",t.ElementDisplayed="element_displayed",t.FormEngagement="form_engagement",t.FormSubmission="form_submission",t.MediaInteraction="media_interaction",t.NavInteraction="nav_interaction",t.RetailProcess="retail_process",t.SpecialOffer="special_offer"}(e||(e={})),function(t){t.Unknown="",t.Start="start",t.Idle="idle",t.Timeout="timeout",t.Engage="engage",t.Close="close"}(n||(n={}));class i{static IsInputPartOfForm(t){if(t instanceof HTMLInputElement&&"text"===t.type||t instanceof HTMLTextAreaElement){if(t.dataset.dotaggingEvent===e.ElementConfiguration)return!1;if(t.closest("form"))return!0}return!1}static DispatchTaggingEvent(t){window.dispatchEvent(new CustomEvent("dotagging.event",{bubbles:!0,detail:{data:t}}))}}class s{constructor(t){this.supportedCommands=["selector","script","literal"],this.supportedScripts=["geturl"],this.parseCommand(t)}parseCommand(t){const e=t.split("::");if(this.command=e[0],e.length>1){const t=e[1].split(",");this.primaryInstruction=t[0],t.length>1&&(this.secondaryInstruction=t[1])}if(e.length>2){const t=e[2].split(",");this.defaultInstruction=t[0],t.length>1&&(this.defaultSecondaryInstruction=t[1])}}get IsValid(){return!(!this.command||!this.primaryInstruction)&&(!("script"==this.command&&!this.supportedScripts.includes(this.primaryInstruction))&&this.supportedCommands.includes(this.command))}}var a;class r{constructor(){this.event="",this.context="",this.event_action_result="",this.event_owner="",this.product_name="",this.product_type="",this.product_type_version="",this.department="",this.element_state="",this.element_text="",this.element_value="",this.element_order="",this.element_type="",this.element_subtype="",this.element_color="",this.element_position="",this.element_title="",this.item_id="",this.item_number="",this.item_price="",this.item_condition="",this.item_year="",this.item_make="",this.item_model="",this.item_variant="",this.item_color="",this.item_category="",this.item_fuel_type="",this.item_inventory_date="",this.item_type="",this.item_payment="",this.item_order="",this.flow_name="",this.flow_stage="",this.flow_outcome=""}fillEventData(t){this.event=this.getDataValue(t.dataset.dotaggingEvent),this.searchDomForItems(t),Object.entries(this).forEach((([e,n])=>{if(!n)switch(e){case"element_color":this[e]=this.getDataValue(t.dataset[`dotagging${this.getKeyName(e)}`],this.getElementColor(t));break;case"element_value":this[e]=this.getDataValue(t.dataset[`dotagging${this.getKeyName(e)}`],this.getElementValue(t));break;case"element_text":this[e]=this.getDataValue(t.dataset[`dotagging${this.getKeyName(e)}`],this.getElementText(t));break;case"element_title":this[e]=this.getDataValue(t.dataset[`dotagging${this.getKeyName(e)}`],this.getElementTitle(t));break;case"link_url":this[e]=this.getDataValue(t.dataset[`dotagging${this.getKeyName(e)}`],t?.href);break;default:this[e]=this.getDataValue(t.dataset[`dotagging${this.getKeyName(e)}`])}}))}getDataValue(t,e=""){return t?new class{constructor(t){this.commands=[],this.isParsable=!1,this.item=t,this.parseCommands(t)}parseCommands(t){t.split("|").forEach((t=>{const e=new s(t);e.IsValid&&this.commands.push(e)})),this.commands.length>0&&(this.isParsable=!0)}get Value(){if(!this.isParsable)return this.item;let t="";for(const e of this.commands)switch(e.command){case"selector":let n=this.getElementValue(e.primaryInstruction,e.secondaryInstruction);!n&&e.defaultInstruction&&(n=this.getElementValue(e.defaultInstruction,e.defaultSecondaryInstruction)),t+=n;break;case"literal":t+=e.primaryInstruction;break;case"geturl":t+=window.location.href}return t||this.item}getElementValue(t,e){const n=document.querySelectorAll(t),s=[];return n.forEach((t=>{let n;if(e)n=e?.startsWith("data-")?t?.getAttribute(e):this.getElementValue(e);else if(t instanceof HTMLSelectElement){const e=t[t.selectedIndex].innerText;e&&(n=e)}else t instanceof HTMLInputElement?n=i.IsInputPartOfForm(t)?"***":t.value??t.textContent??t.innerText:t instanceof HTMLElement&&(n=t.textContent??t.innerText);n&&s.push(n)})),0==s.length?"":s.join(",")}}(t).Value??e:e}getElementColor(t){const e=window.getComputedStyle(t).getPropertyValue("background-color").match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(,\s*\d+\.*\d+)?\)$/);return e?"#"+[parseInt(e[1]),parseInt(e[2]),parseInt(e[3])].map((t=>{const e=t.toString(16);return 1===e.length?"0"+e:e})).join(""):""}getElementValue(t){return i.IsInputPartOfForm(t)?"***":t instanceof HTMLInputElement||t instanceof HTMLSelectElement?this.getDataValue(t.dataset.dotaggingElementValue,t.value):this.getDataValue(t.dataset.dotaggingElementValue)}getElementText(t){let e=(t.textContent??t.innerText).trim();return t instanceof HTMLFormElement?this.getDataValue(t.dataset.dotaggingElementText):(t instanceof HTMLSelectElement&&(e=t.options[t.selectedIndex].text),t instanceof HTMLInputElement&&(e="button"===t.type.toLowerCase()?t.value:t.placeholder),t instanceof HTMLImageElement&&(e=t.alt),"i"===t.tagName.toLowerCase()&&(e=t.getAttribute("alt")??e),this.getDataValue(t.dataset.dotaggingElementText,e))}getElementTitle(t){const e=document.querySelector(`[for="${t.id}"]`);let n="";return e&&(n=e.textContent??e.innerHTML),n||(t instanceof HTMLInputElement&&(n=t.placeholder),t instanceof HTMLSelectElement&&(n=t.options[t.selectedIndex].text)),this.getDataValue(t.dataset.dotaggingElementValue,n)}searchDomForItems(t){const e=new Map,n="dotagging";let i=t;for(;null!==i;){for(const t of Object.keys(i.dataset))if(t.startsWith(n)){const s=t.replace(n,""),a=this.getKeyName(s);Object.keys(this).includes(a)&&!e.has(a)&&e.set(a,this.getDataValue(i.dataset[t]))}i=i.parentElement}e.forEach(((t,e)=>{this[e]=t}))}getKeyName(t){return`${t.split(/(?=[A-Z])/).join("_").toLocaleLowerCase()}`}}class o extends r{constructor(t){super(),this.event_action="click",this.link_url="",super.fillEventData(t)}}class l extends r{constructor(t){super(),this.event_action="click",this.comm_phone_number="",this.affiliation="",super.fillEventData(t)}}class c extends r{constructor(t){super(),this.event_action="click",this.link_url="",super.fillEventData(t)}}class g extends r{constructor(t){super(),this.event_action="view",this.department="",this.promotion_name="",super.fillEventData(t)}}class m extends r{constructor(t){super(),this.event_action="click",this.form_name="",this.form_type="",this.comm_type="",this.comm_status="",super.fillEventData(t)}}class h extends r{constructor(t){super(),this.event_action="click",this.submission_id="",this.form_name="",this.form_type="",this.comm_outcome="",this.comm_type="",super.fillEventData(t)}}class d extends r{constructor(t){super(),this.event_action="click",this.affiliation="",this.media_type="",this.link_url="",this.creative_name="",super.fillEventData(t)}}class u extends r{constructor(t){super(),this.event_action="click",this.link_url="",super.fillEventData(t)}}class p extends r{constructor(t){super(),this.event_action="click",super.fillEventData(t)}}class E extends r{constructor(t){super(),this.event_action="view",this.promotion_id="",this.promotion_name="",super.fillEventData(t)}}!function(t){t.Idle="idle",t.Timeout="timeout"}(a||(a={}));class v{constructor(t){this._watchType=a.Idle,this._intervalId=0,this.setWatcherCommStatus=t=>{this.FormElem.dataset.dotaggingCommStatus=t},this.getInterval=()=>this._watchType===a.Idle?parseInt(this.FormElem.dataset.dotaggingIdle??"60000"):parseInt(this.FormElem.dataset.dotaggingTimeout??"300000"),this.FormElem=t}start(t=a.Idle){this._intervalId=window.setInterval((()=>{switch(t){case a.Idle:{this.setWatcherCommStatus(n.Idle);const t=new m(this.FormElem);this.SendEvent(t),this.stop(),this.start(a.Timeout)}break;case a.Timeout:{this.setWatcherCommStatus(n.Timeout);const t=new m(this.FormElem);this.SendEvent(t),this.stop()}break;default:this.stop()}}),this.getInterval())}SendEvent(t){i.DispatchTaggingEvent(t)}stop(){window.clearInterval(this._intervalId),this._intervalId=0}}const _="1"==new URLSearchParams(window.location.search).get("dotagging_debug"),f=new class{debug(...t){_&&console.debug("[dotagging:debug]",...t)}info(...t){_&&console.info("[dotagging:info]",...t)}warn(...t){_&&console.warn("[dotagging:warning]",...t)}error(...t){_&&console.warn("[dotagging:error]",...t)}},y=new t(t.getBaseUrlFromScript(),f),w=new class{constructor(t){this._apiService=t}getData(t){const{dealerId:e,pageId:n,items:i,itemCount:s,statusCode:a}=t,r=new URLSearchParams;if(r.set("dealerId",e.toString()),r.set("pageId",n.toString()),r.set("statusCode",a?.toString()||""),void 0!==s&&r.set("itemCount",s.toString()),null!=i)for(const t of i)r.append("item",t);return r.toString().length<=200?this._apiService.get("/DataLayer/Init",r):this._apiService.post("/DataLayer/Init",r)}}(y),b=new class{constructor(t){this._logger=t}push(t){this._logger.info("Pushing data onto the data layer:",t),window.dataLayer.push(t)}get name(){return"dataLayer"}}(f),S=new class{constructor(t,e){this._initialized=!1,this._dataLayer=t,this._logger=e}init(){this._initialized||(this.attachListener(),this._initialized=!0)}attachListener(){this._logger.debug("Initializing low level event API service"),window.addEventListener("dotagging.event",(t=>{this._logger.debug("Low level event API received event",t);const e=t?.detail?.data??null;if(!e||!e.event)return void console.error("dotagging event data is missing");const{event:n}=e,i=n.startsWith("do.")?n:`do.${n}`;this._dataLayer.push({event:i,do:{...e}})}))}}(b,f),I=new class{constructor(){this._watchedForms=new Array}find(t){return this._watchedForms.find((e=>e.FormElem.id===t.id))}start(t){if(t instanceof HTMLFormElement){let e=this.find(t);e||(e=new v(t),e.start(),this._watchedForms.push(e))}}stop(t){if(t instanceof HTMLFormElement){const e=this.find(t);e&&e.stop()}}delete(t){const e=this._watchedForms.findIndex((e=>e.FormElem.id===t.FormElem.id));this._watchedForms.splice(e,1)}},T=new class{constructor(t,i,s){this._taggingEventAttribute="data-dotagging-event",this._initialized=!1,this.formEngagementSubmitEventListener=t=>{t.preventDefault();const i=t.target.closest("form");this.setFormCommStatus(i,n.Close);const s=this.createEventByType(i);this.sendEvent(i,s),this._formWatcherService.stop(i);const a=t.submitter??i,r=new h(a);r.event=e.FormSubmission,r.element_type="form",r.element_subtype="cta_button",this.sendEvent(i,r)},this._lowLevelEventService=t,this._formWatcherService=i,this._logger=s,this.boundFormEngagementInputChangeEventHandler=this.formEngagementInputChangeEventListener.bind(this),this.boundFormEngagementSubmitEventHandler=this.formEngagementSubmitEventListener.bind(this)}init(){"loading"!==document.readyState?this.initEvents():document.addEventListener("DOMContentLoaded",(()=>{this.initEvents()}))}initEvents(){if(!this._initialized){this._lowLevelEventService.init();const t=[...document.querySelectorAll(`[${this._taggingEventAttribute}]`)];this.attachEvents(t),this.initDynamicElementObserver(),this.initDisplayElementObserver(),this._initialized=!0,this._logger.debug("DOM event service initialized")}}initDynamicElementObserver(){new MutationObserver((t=>{for(const e of t)"childList"===e.type&&e.addedNodes.forEach((t=>{if(t instanceof HTMLElement){const e=[...t.querySelectorAll(`[${this._taggingEventAttribute}]`)];t.hasAttribute(`${this._taggingEventAttribute}`)&&e.push(t),this.attachEvents(e)}}))})).observe(document.body,{attributes:!1,childList:!0,subtree:!0}),this._logger.debug("Observing DOM changes for new events")}initDisplayElementObserver(){const t=`[data-dotagging-event="${e.ElementDisplayed}"],[data-dotagging-event="${e.SpecialOffer}"]`,n=document.querySelectorAll(`${t}`);if(n.length>0){const t=new IntersectionObserver((t=>{t.forEach((t=>{const e=t.target;if(t.isIntersecting){const t=this.createEventByType(e);this.sendEvent(e,t)}}))}),{root:null,rootMargin:"0px",threshold:.5});[...n].forEach((e=>{const n=e;"true"!==n.dataset.dotaggingEnabled&&(n.dataset.dotaggingEnabled="true",t.observe(e))}))}}formEngagementInputChangeEventListener(t){const i=t.target,s=i.closest("form");this.checkForFormEngageStart(s),this.setFormCommStatus(s,n.Engage);const a=i;a.dataset.dotaggingEvent=e.FormEngagement,a.dataset.dotaggingCommStatus=n.Engage,a.dataset.dotaggingElementSubtype="input_field",a.dataset.dotaggingEventAction="field_input";const r=this.createEventByType(i);this.sendEvent(i,r)}checkForFormEngageStart(t){if(this.getFormCommStatus(t)==n.Timeout||this.getFormCommStatus(t)==n.Idle||this.getFormCommStatus(t)==n.Close||this.getFormCommStatus(t)==n.Unknown){this.setFormCommStatus(t,n.Start);const e=this.createEventByType(t);this.sendEvent(t,e),this._formWatcherService.start(t)}}setupDataEvent(t){if("true"!==t.dataset.dotaggingEnabled)switch(this._logger.debug("Observing element",t),t.dataset.dotaggingEvent){case e.ElementDisplayed:case e.SpecialOffer:case e.RetailProcess:break;case e.FormEngagement:t instanceof HTMLFormElement&&(this.setFormCommStatus(t,n.Unknown),t.querySelectorAll("input:not([type=button]),select,textarea").forEach(((t,e)=>{t.dataset.dotaggingElementOrder=e.toString(),t.removeEventListener("change",this.boundFormEngagementInputChangeEventHandler,!0),t.addEventListener("change",this.boundFormEngagementInputChangeEventHandler,!0)})),t.dataset.dotaggingElementType="form",t.removeEventListener("submit",this.boundFormEngagementSubmitEventHandler,!0),t.addEventListener("submit",this.boundFormEngagementSubmitEventHandler,!0));break;case e.FormSubmission:{const e=this.createEventByType(t);this.sendEvent(t,e),t.dataset.dotaggingEnabled="true"}break;default:{let e="click";(t instanceof HTMLInputElement&&"checkbox"===t.type||t instanceof HTMLInputElement&&"text"===t.type||t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement)&&(e="change"),t.addEventListener(e,(()=>{const e=this.createEventByType(t);this.sendEvent(t,e)})),t.dataset.dotaggingEnabled="true"}}}sendEvent(t,e){i.DispatchTaggingEvent(e)}attachEvents(t){t.forEach((t=>{this.setupDataEvent(t)}))}setFormCommStatus(t,e){t.dataset.dotaggingCommStatus=e}getFormCommStatus(t){return t.dataset.dotaggingCommStatus??""}createEventByType(t){switch(t.dataset.dotaggingEvent){case e.ClickToCall:return new l(t);case e.ElementConfiguration:return new c(t);case e.ElementDisplayed:return new g(t);case e.FormEngagement:return new m(t);case e.FormSubmission:return new h(t);case e.MediaInteraction:return new d(t);case e.NavInteraction:return new u(t);case e.RetailProcess:return new p(t);case e.SpecialOffer:return new E(t);case e.CtaInteraction:default:return new o(t)}}}(S,I,f),L=new class{constructor(t,e,n,i){this._dataLayer=t,this._initialDataService=e,this._eventService=n,this._logger=i}async initialize(){this._initGtm();const t=this._getTaggingData();if(null!=t)try{const e=await this._initialDataService.getData(t);this._dataLayer.push({event:e.event,do:{...e}}),this._eventService.init(),this._logger.info("GTM tracker initialized")}catch(t){this._logger.error("GTM tracker failed to initialize",t)}else this._logger.warn("Unable to load tagging data. Events will not fire.")}_getTaggingData(){const t="script#dealeron_tagging_data[type='application/json']",e=document.querySelector(t);return null===e?(console.debug(`Missing tagging data element (${t})`),null):JSON.parse(e.innerHTML)}_initGtm(){this._logger.info("Initializing GTM"),this._dataLayer.push({event:"gtm.js","gtm.start":(new Date).getTime()});const t=document.createElement("script");t.async=!0;const e="https://www.googletagmanager.com/gtm.js?id=GTM-WBJPXB7";t.src="dataLayer"===this._dataLayer.name?e:`${e}&l=${this._dataLayer.name}`;const n=document.getElementsByTagName("script")[0];n.parentNode?.insertBefore(t,n)}}(b,w,T,f);(async()=>{await L.initialize(),f.debug("Tracker Initialized")})()}();