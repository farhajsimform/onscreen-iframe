"use strict";dealeron.runtime.define(["system/http","system/logManager","system/linq","system/async","system/text","core/inventory/filters","core/inventory/Vehicle"],(s,e,n,r,t,i,o)=>{function a(e,r){return r=r||window.location.href,e=e.replace(/[\[\]]/g,"\\$&"),(e=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(r))?e[2]?decodeURIComponent(e[2].replace(/\+/g," ")):"":null}let l=e.getLogger("Inventory Collection Manager");function h(e){var r;return"string"==typeof e?(r=e.replace(/^"(.*)"$/,"$1"),JSON.parse(r)):e}class c{constructor(e){this._limitMakesTo=h((e=e||{}).limitMakesTo),this._limitYearsTo=h(e.limitYearsTo),this._limitModelTo=h(e.limitModelTo),this._vehiclePromises={},this._vehicleMakeDealers={},this._newInventoryOnly=e.newInventoryOnly}_buildInventory(e){let i=[];return n.Enumerable.from(e.Makes).where(e=>!this._limitMakesTo||-1!==this._limitMakesTo.indexOf(e.Name.toLowerCase())).forEach(e=>{let t=e.Name;n.Enumerable.from(e.Models).forEach(e=>{let r=e.Name;n.Enumerable.from(e.Years).where(e=>!this._limitYearsTo||-1!==this._limitYearsTo.indexOf(e)).forEach(e=>i.push(new o({Type:"V",Year:e,Make:t,Model:r})))})}),n.Enumerable.from(i)}_buildMakeSpecificInventory(e){let l=[],s=e.Name;return this._vehicleMakeDealers[s.toLowerCase()]=e.Dealers,n.Enumerable.from(e.Models).where(e=>!this._limitModelTo||-1!==this._limitModelTo.indexOf(e.Name.toLowerCase())).forEach(e=>{let i=e.Name;n.Enumerable.from(e.Trims).forEach(e=>{let r=e.Name,t=e.Bodystyle;n.Enumerable.from(e.Years).where(e=>!this._limitYearsTo||-1!==this._limitYearsTo.indexOf(e)).forEach(e=>{l.push(new o({Type:"V",Year:e,Make:s,Model:i,Trim:r,Bodystyle:t}))})})}),n.Enumerable.from(l)}_fetchRefData(i){var l="all";return null!=this._newInventoryOnly&&""!=this._newInventoryOnly&&(l=this._newInventoryOnly),r.await((r,t)=>{var e=(e=a("header")||"")&&("//"!=e.substr(0,2)&&"//"+e||e)||"";s.get(e+"/api/virtual/inventory/{inventoryType}/{make}",{make:(i||"").replace(/\s/g,"_"),inventoryType:l}).success(e=>r(i?this._buildMakeSpecificInventory(e):this._buildInventory(e))).error(e=>t(e))})}search(s){let o=s.firstOrDefault(e=>"Make"===e.field),a=o?o.value.toLowerCase():null,e=(this._limitMakesTo&&1===this._limitMakesTo.length&&(a=this._limitMakesTo[0]),this._vehiclePromises[a||"all"]?this._vehiclePromises[a||"all"]:this._vehiclePromises[a||"all"]=this._fetchRefData(a));return r.await((i,l)=>{e.then((e,r)=>{e&&l(e);e=document.querySelector("#selDealer");null!=e&&"User Selected Make"===e.dataset.grouplocation&&(null!=a&&void 0!==this._vehicleMakeDealers[a]?[...e.options].slice(1).forEach(e=>{-1<this._vehicleMakeDealers[a].indexOf(e.text)?e.hidden=e.disabled=!1:e.hidden=e.disabled=!0}):[...e.options].slice(1).forEach(e=>{e.hidden=!1,e.disabled=!1}),e.options[0].selected=!0);let t=o?s:s.where(e=>"Trim"!=e.field);e=r.where(r=>t.where(e=>null!==e).all(e=>e.apply(r))).toArray();i(n.Enumerable.from(e))})})}}class m{constructor(e){this._isFirstSearch=!0,this._baseFilter=e||"",this._vehiclePromise=r.await((r,i)=>{var e=this._baseFilter||"";l.info('Getting vehicles for filter "{0}"',e);var t=(t=a("header")||"")&&("//"!=t.substr(0,2)&&"//"+t||t)||"";s.get(t+"/api/inventory/query/").query({filter:window.btoa(e),encoded:!0}).success(e=>{l.info("Retrieved vehicles from inventory API");e=n.Enumerable.from(e).select(e=>new o(e)),e=n.Enumerable.from(e.toArray());r(e)}).error((e,r,t)=>{i(new Error("Inventory API failed with status "+r))})})}search(s){return s=n.Enumerable.from(s),r.await((r,t)=>{this._vehiclePromise.then((e,i)=>{if(e)t(e);else{if(this._isFirstSearch){let r=!1,t=!1;i.forEach(e=>{"N"==e.Type?r=!0:"U"==e.Type&&(t=!0)});var l,e=document.getElementById("searchByFilterType");e&&!r&&(l=e.querySelector('option[value="Type:N"]'))&&(e.removeChild(l),s=s.where(e=>!("Type"==e.field&&"N"==e.value))),e&&!t&&(l=e.querySelector('option[value="Type:U"]'))&&(e.removeChild(l),s=s.where(e=>!("Type"==e.field&&"U"==e.value))),this._isFirstSearch=!1}e=i.where(r=>s.where(e=>null!==e).all(e=>e.apply(r))).toArray();r(n.Enumerable.from(e))}})})}}return new class{constructor(){this._collections={}}createCollection(e){return this._collections[e]||(this._collections[e]=new m(e))}createVirtualCollection(e){return new c(e)}buildQuerystring(e){return e.select(e=>e.toString()).toArray().join("&").replace("+","%2B")}}});