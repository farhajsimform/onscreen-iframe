"use strict";dealeron.runtime.define(["core/inventory/inventoryManager","core/inventory/filters","system/text","system/logManager","system/linq","system/async","system/html"],(i,h,d,e,c,r,s)=>{let n=e.getLogger("Inventory Search Widget"),l=window.DealerOnTrack?window.DealerOnTrack.event:null,a=window.jQuery;a||n.warn("jQuery is not detected on this page. The widget will work, but animated count will not."),l||n.warn("DealerOnTrack.event is not detected on this page. Google Analytics tracking will not happen.");const g={orMore:"or more",orLess:"or less",maxPrice:99999999,minPrice:1,filterAttribute:"inventory-filter",actionAttribute:"inventory-action",infoAttribute:"inventory-info",placeholderAttribute:"inventory-filter-placeholder",dependAttribute:"inventory-depend-on",defaultPriceRanges:[{low:null,high:5e3},{low:5001,high:1e4},{low:10001,high:15e3},{low:15001,high:2e4},{low:20001,high:25e3},{low:25001,high:3e4},{low:30001,high:4e4},{low:40001,high:5e4},{low:50001,high:6e4},{low:60001,high:null}],defaultAnimationDuration:1e3,defaultPlaceholder:"Any {field}",filterPattern:/(\w+)\:?(\w*)/,staticFilter:"condition",updateFilters:"update-filters"};class u{constructor(e,t,r,i){this.element=e,this.property=t,this.availableFilters=r,this._isFirstUpdate=i}toString(){return""+this.property}updateElement(s,e,o){let[,c,t]=g.filterPattern.exec(this.element.getAttribute(g.filterAttribute));if("SELECT"===this.element.tagName&&c!==g.staticFilter){let a=this.element[this.element.selectedIndex].value;if(this.element.options.length=0,this._writePlaceholder(),!this.element.disabled){var u=1===this.availableFilters.count();let n=a&&this.availableFilters.any(e=>e.innerFilter.value==a),l=("low"!==t||n||(r=this.availableFilters.min(),a=r?r.innerFilter.value:a,o()),"high"!==t||n||(r=this.availableFilters.max(),a=r?r.innerFilter.value:a,o()),null);var r=document.querySelector('select[inventory-filter="condition"]');r&&(l=r.value),this.availableFilters.forEach(e=>{var t,r,i=document.createElement("OPTION");e.innerFilter instanceof h.BasicFilter||e.innerFilter instanceof h.TextFilter||e.innerFilter instanceof h.StockVinFilter||e.innerFilter instanceof h.MultipleValuesFilter?(i.value=e.innerFilter.value,i.innerHTML=d.from("{0}",e.innerFilter.value),!("Make"===c&&s.showMakeBeforeAll&&i.innerHTML===s.showMakeFirst&&this._isFirstUpdate&&"Type:A"==l||u&&!s.selectPlaceholder&&this._isFirstUpdate)&&(!u||s.selectPlaceholder||n)?i.selected=e&&e.innerFilter&&a&&d.equalsIgnoreCase(e.innerFilter.value,a):(i.selected=!0,o())):e.innerFilter instanceof h.RangeFilter&&(i.value=d.from("{0}-{1}",e.innerFilter.low,e.innerFilter.high),r=e.innerFilter.low!==g.minPrice,t=e.innerFilter.high!==g.maxPrice,r&&t?i.innerHTML=d.from("{0} - {1}",p(e.innerFilter.low,this.property),p(e.innerFilter.high,this.property)):!r&&t?i.innerHTML=d.from("{0} {1}",p(e.innerFilter.high,this.property),g.orLess):r&&!t&&(i.innerHTML=d.from("{0} {1}",p(e.innerFilter.low,this.property),g.orMore)),a)&&(r=a.split("-"),t=parseInt(r[0]),r=parseInt(r[1]),i.selected=e&&e.innerFilter&&t===e.innerFilter.low&&r===e.innerFilter.high),"Make"===c&&s.showMakeBeforeAll&&i.innerHTML===s.showMakeFirst&&"Type:A"==l?this.element.insertBefore(i,this.element.firstChild):this.element.appendChild(i)})}}}_writePlaceholder(){var e,t=this.element.getAttribute(g.placeholderAttribute);t&&((e=document.createElement("OPTION")).value="",e.innerHTML=t,this.element.appendChild(e))}}class f{constructor(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;this.innerFilter=e,this.count=t,this.outerFilter=r}apply(e){return this.innerFilter.apply(e)}equals(e){return e instanceof f&&e.innerFilter.equals(this.innerFilter)&&e.count===this.count}toString(){return`${this.innerFilter} (${this.count})`}}function p(e,t){return"Price"===t?o(e):e.toString()}function o(e){return"$"+(e||"").toLocaleString().split(".")[0]}function v(e,r){e=e.where(e=>""<e);return!e.any()||e.all(t=>r.any(e=>e.field===t))}return class{constructor(e,t){t.useVirtual&&n.debug("Inventory widget will use virtual inventory."),t.priceRanges=t.priceRanges||g.defaultPriceRanges,t.animationDuration=t.animationDuration||g.defaultAnimationDuration,this._rootTag=e,this._config=t,this._isFirstUpdate=!0,this._collection=t.useVirtual?i.createVirtualCollection({limitYearsTo:t.virtualYears,limitMakesTo:t.virtualMakes,newInventoryOnly:t.newInventoryOnly,limitModelTo:t.virtualModel}):i.createCollection(t.baseFilter)}start(){this._readForm(),s.query(this._rootTag,"[{filterAttribute}]",g).forEach(e=>this._initializeFilterElement(e)),s.query(this._rootTag,"[{actionAttribute}]",g).forEach(e=>this._activateActionElement(e)),this._rootTag.addEventListener("keypress",e=>{if(13===e.keyCode)this._search(e)}),this._config.rescanOnEvent&&a&&a(this._rootTag).on(this._config.rescanOnEvent,e=>this._readForm(e))}getCurrentFilters(){var e=s.query(this._rootTag,this._config.selector||"[{filterAttribute}]",g).where(e=>!e.disabled).select(e=>this._getSingleFilterOrNull(e)).where(e=>null!==e).toArray();return c.Enumerable.from(e)}_initializeFilterElement(e){e.addEventListener("change",e=>this._readForm(e)),"INPUT"===e.tagName&&(r=e.getAttribute("type"),d.equalsIgnoreCase(r,"TEXT"))&&e.addEventListener("keyup",e=>this._readForm(e));var t,r=e.getAttribute(g.filterAttribute);"SELECT"===e.tagName&&r!==g.staticFilter&&((t=document.createElement("OPTION")).value="",t.innerHTML=e.getAttribute(g.placeholderAttribute)||d.from(g.defaultPlaceholder,{field:r.split(":")[0]}),e.appendChild(t))}_readForm(e){var t=e&&e.target,r=t&&"text"!==e.target.getAttribute("type"),i=t&&("SELECT"!==e.target.tagName||e.target.getAttribute(g.filterAttribute)===g.staticFilter),n=t&&e.target.getAttribute(g.actionAttribute)!==g.updateFilters,t=(t&&(t=s.findParentAttribute(e.target,"inventory-tab"))&&(this._activeTab=t),r&&i&&n);t?this._reset(e):(this._config.selectPlaceholder=null!=e&&null!=e.target&&!e.target.value,this._promiseFormUpdate(this.getCurrentFilters()).execute())}_activateActionElement(e){switch(e.getAttribute(g.actionAttribute).toLowerCase()){case"search":e.addEventListener("click",e=>this._search(e));break;case"reset":e.addEventListener("click",e=>this._reset(e));break;case"first":e.addEventListener("click",e=>this._first(e));break;case"update-filters":e.addEventListener("click",e=>this._readForm(e))}}_getSingleFilterOrNull(e){var t=e.getAttribute(g.filterAttribute),r=s.value(e),i=(e.getAttribute("type")||"").toUpperCase();if(!t||!r||"RADIO"===i&&!e.checked)return null;var[,n,i]=g.filterPattern.exec(t);if("low"===i)return new h.RangeFilter(n,r,null);if("high"===i)return new h.RangeFilter(n,null,r);switch(n){case g.staticFilter:var[,l,a]=/(\w+):(.+)/.exec(r);return new h.BasicFilter(l,d.parseType(a));case"Features":return new h.MultipleValuesFilter(n,r);case"Price":l=r.split("-"),a=parseInt(l[0])||g.minPrice,l=parseInt(l[1])||g.maxPrice;return new h.RangeFilter(n,a,l);case"Vin":case"StockNum":return new h.TextFilter(n,r);case"StockVin":return new h.StockVinFilter(r)}return new h.BasicFilter(n,r)}_removeAFilter(e){return e.any(e=>"A"===e.value)?e.where(e=>"A"!==e.value):e}_removeTypeFilters(e){return e.any(e=>"Type"===e.field)?e.where(e=>"Type"!==e.field):e}_promiseFormUpdate(l){return r.await((n,t)=>{this._collection.search(this._removeAFilter(l)).then((e,i)=>{e?t(e):((e=s.query(this._rootTag,"[{filterAttribute}]",g)).forEach(e=>this._processDependencies(e,l)),e=e.select(e=>this._promiseRefinements(e,this._getSingleFilterOrNull(e),this.getCurrentFilters())).where(e=>null!==e),r.awaitAll(e).then((e,r)=>{if(e)t(e);else{let e=!1,t=()=>e=!0;r.forEach(e=>e.updateElement(this._config,l,t)),s.query(this._rootTag,"[{infoAttribute}]",g).forEach(e=>this._updateDataElement(e,i)),s.query(this._rootTag,"[{actionAttribute}]",g).forEach(e=>this._checkActionElement(e,l,i)),e&&this._promiseFormUpdate(this.getCurrentFilters()).execute(),this._isFirstUpdate=!1,n()}}))})})}_processDependencies(e,t){t=v(c.Enumerable.from((e.getAttribute(g.dependAttribute)||"").split(",")),t);e.disabled=!t}_promiseRefinements(n,t,e){let l=this._config.showMakeFirst;if("SELECT"!==n.tagName||n.getAttribute(g.filterAttribute)===g.staticFilter)return null;let[,a,,]=g.filterPattern.exec(n.getAttribute(g.filterAttribute)),s=this._config.useVirtual&&"Make"===a?e.where(e=>!e.equals(t)&&-1!==["Year","Make","Model"].indexOf(e.field)):e.where(e=>!e.equals(t)),o=null;e=document.querySelector('select[inventory-filter="condition"]');switch(e&&(o=e.value),a){case"Price":return r.await((i,e)=>{this._collection.search(s).then((t,r)=>{if(t)e(t);else{let e=c.Enumerable.from(this._config.priceRanges);t=r.select(e=>e.Price).where(e=>0<e).groupBy(t=>e.firstOrDefault(e=>(null===e.low||t>=e.low)&&(null===e.high||t<=e.high))).where(e=>null!==e.key()).select(e=>new f(new h.RangeFilter(a,e.key().low||g.minPrice,e.key().high||g.maxPrice),e.count())).orderBy(e=>e.innerFilter.low);i(new u(n,a,t,this._isFirstUpdate))}})});case"Features":return r.await((t,i)=>{this._collection.search(s).then((e,r)=>{e?i(e):(e=r.selectMany(e=>e[a]).distinct().select(t=>new f(new h.MultipleValuesFilter(a,t),r.count(e=>-1!==e[a].indexOf(t)))).orderBy(e=>e.innerFilter.low),t(new u(n,a,e,this._isFirstUpdate)))})});default:return r.await((r,i)=>{this._collection.search(this._removeAFilter(s)).then((e,t)=>{if(e)i(e);else{let e;e="Model"===a&&"Type:A"==o?t.groupBy(e=>e[a],null,null,e=>(""+e).toLowerCase()).where(e=>""<e.key()).select(e=>new f(new h.BasicFilter(a,e.key()),e.count(),e.getSource()[0].Make)).orderByDescending(e=>e.outerFilter===this._config.showMakeModelsFirst).thenBy(e=>e.innerFilter.value):t.groupBy(e=>e[a],null,null,e=>(""+e).toLowerCase()).where(e=>""<e.key()).select(e=>new f(new h.BasicFilter(a,e.key()),e.count())).orderByDescending(e=>"Make"!==e.innerFilter.field||e.innerFilter.value===l).thenBy(e=>"Year"===e.innerFilter.field?-1*e.innerFilter.value:e.innerFilter.value),r(new u(n,a,e,this._isFirstUpdate))}})})}}_updateDataElement(t,e){var r=t.getAttribute(g.infoAttribute)||"",i=this.getCurrentFilters().where(e=>null!==e);switch(r.toLowerCase()){case"animatedcount":var n=Number(t.innerHTML)||0,l=e.count();return a?void a({Counter:n}).animate({Counter:l},{duration:this._config.animationDuration,easing:"swing",step:e=>t.innerHTML=Math.ceil(e).toLocaleString().split(".")[0]}):void(t.innerHTML=e.count().toLocaleString().split(".")[0]);case"count":n=e.count().toLocaleString().split(".")[0],l=(t.innerHTML=n,new CustomEvent("inventorywidget-update-inventory-count",{detail:n}));return void document.dispatchEvent(l);case"minprice":return void(t.innerHTML=o(e.where(e=>0<e.Price).min(e=>e.Price)));case"maxprice":return void(t.innerHTML=o(e.max(e=>e.Price)));case"avgprice":return void(t.innerHTML=o(e.average(e=>e.Price)));case"serializedfilters":return void(t.innerHTML=this._getSearchUrl(i,e.firstOrDefault()));case"modelphoto":n=i.firstOrDefault(e=>"Model"===e.field),l=e.firstOrDefault();if(n&&l){t.setAttribute("src",l.getPhotoUrl());n="for a "+l.Year+" "+l.Make+" "+l.Model;let e=t.getAttribute("default-alt").replace("drive at ","drive "+n+" at ");e=e.replace("quote from ","quote "+n+" from "),t.setAttribute("alt",e),t.onerror=()=>{t.setAttribute("src",t.getAttribute("default-src")),t.setAttribute("alt",t.getAttribute("default-alt"))}}else t.setAttribute("src",t.getAttribute("default-src")),t.setAttribute("alt",t.getAttribute("default-alt"));return}}_checkActionElement(r,i,n){var l=v(c.Enumerable.from((r.getAttribute(g.dependAttribute)||"").split(",")),i);if(r.disabled=!l,l?r.removeAttribute("disabled"):r.setAttribute("disabled",!0),"search"===r.getAttribute(g.actionAttribute).toLowerCase()){l=i.firstOrDefault(e=>"CPO"===e.field.toUpperCase()||"CARBRAVO"===e.field.toUpperCase()||e.value&&"string"==typeof e.value&&("N"===e.value.toUpperCase()||"U"===e.value.toUpperCase()||"V"===e.value.toUpperCase()||"C"===e.value.toUpperCase()||"A"===e.value.toUpperCase())),n=n.firstOrDefault();let e="default",t=(l?e="CPO"===l.field.toUpperCase()||"CARBRAVO"===l.field.toUpperCase()?"C":l.value:n&&(e=n.Type),this._getSearchUrl(e,i));r.classList.contains("search-by-filter__search-button")?r.onclick=()=>{window.location.href=t}:r.setAttribute("href",t)}}_getSearchUrl(e,t){var r=i.buildQuerystring(this._removeTypeFilters(t));switch(e){case"A":return(this._config.allSearchPage||"/searchall.aspx")+"?"+r;case"N":return(this._config.newSearchPage||"/searchnew.aspx")+"?"+r;case"U":return(this._config.usedSearchPage||"/searchused.aspx")+"?"+r;case"V":return"/searchnewv.aspx?"+r;case"C":return(this._config.usedSearchPage||"/searchused.aspx")+"?"+r;default:return(this._config.newSearchPage||"/searchnew.aspx")+"?"+r}}_search(e){let t="Vertical Search Widget Inv. Searches";s.isHorizontal(e.target,"horizontalInventorySearch")&&(t="Horizontal Search Widget Inv. Searches"),l&&!this._config.disableTracking&&(n.debug("Sending Google Analytics Tracking Event"),DealerOnTrack.event(t,this._activeTab||"Default Search",i.buildQuerystring(this.getCurrentFilters())))}_first(r){var e=this.getCurrentFilters();this._collection.search(e).then((e,t)=>{if(e)throw e;e=t.firstOrDefault();null===e?(n.error("No vehicles"),r.preventDefault()):e.isVirtual()?(n.error("Cannot go directly to virtual VDP. Vehicle ID is not known."),r.preventDefault()):(t=e.getDetailsPageUrl(),n.info("Navigating to vehicle {0}",t),l&&!this._config.disableTracking&&DealerOnTrack.event("Inventory Search Widget","Direct",e.Vin),window.location.href=t)}),r.preventDefault()}_reset(e){n.debug("Resetting Filters"),s.query(this._rootTag,"select[{filterAttribute}]",g).where(e=>e.getAttribute(g.filterAttribute)!==g.staticFilter).forEach(e=>e.selectedIndex=0),this._isFirstUpdate=!0,this._promiseFormUpdate(this.getCurrentFilters()).then(()=>n.debug("Form reset"))}}});